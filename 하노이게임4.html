<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í•˜ë…¸ì´íƒ‘ ì§ì ‘ í”Œë ˆì´ (ì‹œê°„ & ìµœê³ ê¸°ë¡)</title>
<style>
  body { text-align:center; background:#f4f4f4; font-family:"ë§‘ì€ ê³ ë”•",sans-serif; margin:0; }
  h1 { margin-top:10px; color:#333; font-size:clamp(18px,3vw,28px); }
  h2 { margin-top:10px; font-size:clamp(16px,2.5vw,24px); }
  canvas{
    background:#fff; border:2px solid #888; border-radius:10px; margin-top:15px;
    width:95%; max-width:800px; height:auto; touch-action:manipulation; -webkit-tap-highlight-color:transparent;
  }
  #info{ margin-top:8px; font-size:clamp(14px,2vw,18px); display:inline-block; padding:2px 6px; border-radius:6px; }
  button{
    margin:4px; padding:8px 12px; border-radius:8px; border:none; background:#5a7dff; color:#fff;
    font-size:clamp(12px,2vw,16px); cursor:pointer; transition:.2s;
  }
  button:hover{ background:#3b5ed9; transform:scale(1.05); }
  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; }
  #nameBox{
    background:#fff; padding:25px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.3);
    max-width:360px; text-align:left;
  }
  #nameBox h2,#nameBox p{ text-align:center; }
  input{ padding:8px; font-size:16px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
  .rules{ margin-top:12px; background:#f9f9ff; border:1px solid #e2e6ff; border-radius:8px; padding:10px 12px; font-size:14px; color:#333; }
  .rules strong{ display:block; margin-bottom:6px; color:#3b5ed9; }
  .toolbar{ margin-top:6px; }
  .modebar{ margin-top:4px; }
  .modebar span{ font-size:14px; margin-right:4px; }
  #perfect{ font-size:28px; color:#ff4081; font-weight:bold; animation:pop 1.2s ease; min-height:1.4em; }
  #recordBadge{ font-size:20px; color:#ff9800; font-weight:700; min-height:1.4em; }
  .flash{ animation:flashbg .9s ease 2; }
  @keyframes pop{ 0%{transform:scale(.5);opacity:0} 50%{transform:scale(1.2);opacity:1} 100%{transform:scale(1);opacity:1} }
  @keyframes flashbg{ 0%,100%{ background-color:transparent } 50%{ background-color:#fff3cd } }
</style>
</head>
<body>
  <h1>ğŸ§  í•˜ë…¸ì´íƒ‘ ê²Œì„ | ë§Œë“ ì´: ê²½ì¸êµëŒ€ ìŒì•…êµìœ¡ê³¼ ì£¼ì€í–¥</h1>

  <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´ -->
  <div id="overlay">
    <div id="nameBox">
      <h2>í•˜ë…¸ì´íƒ‘ ë„ì „í•˜ê¸°</h2>
      <p>ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</p>
      <input type="text" id="playerName" placeholder="ì˜ˆ: ì§€í˜„, ë¯¼ìˆ˜, ì˜ìš°" onkeydown="if(event.key==='Enter') startGame()">
      <div class="rules">
        <strong>ê²Œì„ ê·œì¹™</strong>
        <ol style="margin:0 0 0 18px; padding:0;">
          <li>í•œë²ˆì— í•˜ë‚˜ì”©, ë§¨ ìœ„ì— ìˆëŠ” ê³ ë¦¬ë§Œ ì˜®ê¸°ê¸°</li>
          <li>ì‘ì€ ê³ ë¦¬ ìœ„ì— í° ê³ ë¦¬ë¥¼ ì˜¬ë¦´ ìˆ˜ ì—†ìŒ</li>
        </ol>
      </div>
      <div class="rules" style="margin-top:12px;">
        <strong>ëª¨ë“œ ì„ íƒ</strong>
        <label><input type="radio" name="modeSel" value="practice" checked> ì—°ìŠµ ëª¨ë“œ (ê¸°ë¡ ì €ì¥ ì•ˆ í•¨)</label><br>
        <label><input type="radio" name="modeSel" value="normal"> ì¼ë°˜ ëª¨ë“œ (ê¸°ë¡ ì €ì¥)</label><br>
        <label><input type="radio" name="modeSel" value="attack"> íƒ€ì„ì–´íƒ ëª¨ë“œ (ê¸°ë¡ ì €ì¥)</label>
        <div style="font-size:12px;color:#666;margin-top:6px;">
          â€¢ ì—°ìŠµ: ì œí•œì‹œê°„ ì—†ìŒ, ê¸°ë¡ ì €ì¥ ì•ˆ í•¨<br>
          â€¢ ì¼ë°˜: ì œí•œì‹œê°„ ì—†ìŒ, ê¸°ë¡ ì €ì¥í•¨<br>
          â€¢ íƒ€ì„ì–´íƒ: ì œí•œì‹œê°„ ë‚´ í´ë¦¬ì–´ ì‹œ ê¸°ë¡ ì €ì¥
        </div>
      </div>
      <div style="text-align:center; margin-top:12px;">
        <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        <button onclick="showRules()">ê·œì¹™ ì„¤ëª…</button>
      </div>
    </div>
  </div>

  <h2 id="greeting" style="display:none;"></h2>

  <div id="levelButtons" style="display:none;">
    <button onclick="setLevel(5)">ë ˆë²¨ 1 (5ê°œ)</button>
    <button onclick="setLevel(6)">ë ˆë²¨ 2 (6ê°œ)</button>
    <button onclick="setLevel(7)">ë ˆë²¨ 3 (7ê°œ)</button>
    <button onclick="setLevel(8)">ë ˆë²¨ 4 (8ê°œ)</button>
    <button onclick="setLevel(9)">ë ˆë²¨ 5 (9ê°œ)</button>
    <button onclick="setLevel(10)">ë ˆë²¨ 6 (10ê°œ)</button>
  </div>

  <canvas id="game" width="800" height="400" style="display:none;"></canvas>
  <div id="info" style="display:none;">ë ˆë²¨ 1 | ì´ë™ íšŸìˆ˜: 0 | ì‹œê°„: 0:00.0</div>

  <!-- ëª¨ë“œ ì „í™˜ ë°” -->
  <div class="modebar" id="modebar" style="display:none;">
    <span>ëª¨ë“œ:</span>
    <button onclick="setGameMode('practice')">ì—°ìŠµ ëª¨ë“œ</button>
    <button onclick="setGameMode('normal')">ì¼ë°˜ ëª¨ë“œ</button>
    <button onclick="setGameMode('attack')">íƒ€ì„ì–´íƒ ëª¨ë“œ</button>
  </div>

  <!-- íˆ´ë°” -->
  <div class="toolbar">
    <button id="restartBtn" style="display:none;" onclick="restartLevel()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
    <button id="undoBtn" style="display:none;" onclick="undoMove()">â†©ï¸ ì´ë™ ì·¨ì†Œ</button>
    <button id="helpBtn" style="display:none;" onclick="showRules()">ğŸ“œ ê·œì¹™ ì„¤ëª…</button>
    <button id="showRecords" style="display:none;" onclick="showBestRecords()">ğŸ† ìµœê³ ê¸°ë¡ ë³´ê¸°</button>
    <button id="showSummary" style="display:none;" onclick="showSummaryRecords()">ğŸ“Š ì „ì²´ ê¸°ë¡ ë³´ê¸°</button>
  </div>

  <div id="perfect"></div>
  <div id="recordBadge"></div>

<script>
/* ===== ì„¤ì • (ê°„ê²©/ë””ìŠ¤í¬ í­ ì¡°ì ˆ) ===== */
const PEG_SPACING = 160;   // ê°€ìš´ë° ê¸°ì¤€ ì¢Œìš° ê°„ê²©(px)
const DISK_SCALE  = 22;    // ë””ìŠ¤í¬ í­ = ë²ˆí˜¸ Ã— DISK_SCALE

/* ===== DOM ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
const greeting = document.getElementById('greeting');

/* ===== ìƒíƒœ ===== */
let n = 5;
let pegs = [[], [], []];
let moveHistory = [];
let selectedPeg = null;
let moveCount = 0;
let startTime = 0;
let timerInterval = null;
let elapsed = 0;            // ms
let player = "";
let mode = 'practice';      // 'practice' | 'normal' | 'attack'
let attackTimeLimitMs = 0;  // íƒ€ì„ì–´íƒ ì œí•œ(ms)
let attackTimeOver = false; // ì‹œê°„ ì´ˆê³¼ í”Œë˜ê·¸

/* í¼í™íŠ¸ ê¸°ì¤€ê³¼ íƒ€ì„ì–´íƒ ì œí•œì˜ ì—¬ìœ ë„ */
const OPT_TIME_PER_MOVE = 1.2;   // (ì´ˆ/ì´ë™)
const ATTACK_TIME_FACTOR = 1.5;  // í¼í™íŠ¸ ê¸°ì¤€ì˜ 1.5ë°°

/* ê·œì¹™ í…ìŠ¤íŠ¸ */
const RULES_TEXT = "1. í•œë²ˆì— í•˜ë‚˜ì”©, ë§¨ ìœ„ì— ìˆëŠ” ê³ ë¦¬ë§Œ ì˜®ê¸°ê¸°\n2. ì‘ì€ ê³ ë¦¬ ìœ„ì— í° ê³ ë¦¬ë¥¼ ì˜¬ë¦´ ìˆ˜ ì—†ìŒ";

/* ===== ìœ í‹¸ ===== */
function formatTime(ms){
  let totalSec = Math.floor(ms/1000), h = Math.floor(totalSec/3600);
  let min = Math.floor((totalSec%3600)/60), sec = totalSec%60;
  let t = Math.floor((ms%1000)/100);
  return h>0 ? `${h}:${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${t}` : `${min}:${String(sec).padStart(2,'0')}.${t}`;
}
function minMovesOf(k){ return Math.pow(2,k)-1; }
function getSelectedModeFromOverlay(){
  const r=document.querySelectorAll("input[name='modeSel']"); for(const x of r) if(x.checked) return x.value; return 'practice';
}
function bestKey(player,level,mode){ return `hanoi_best_${player}_L${level}_mode_${mode}`; }
function afterPaint(fn){ requestAnimationFrame(()=>setTimeout(fn,0)); }
function modeLabel(m){ return m==='attack' ? 'íƒ€ì„ì–´íƒ' : (m==='normal' ? 'ì¼ë°˜' : 'ì—°ìŠµ'); }
function highlightNewRecord(m){
  const badge = document.getElementById('recordBadge');
  badge.textContent = `ğŸ† ì‹ ê¸°ë¡! (${modeLabel(m)})`;
  info.classList.add('flash');
  setTimeout(()=>{ info.classList.remove('flash'); badge.textContent=''; }, 2000);
}

/* ===== ì‹œì‘/ì´ˆê¸°í™” ===== */
function startGame(){
  const nameInput=document.getElementById('playerName').value.trim();
  if(!nameInput) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
  player=nameInput; mode=getSelectedModeFromOverlay();

  document.getElementById('overlay').style.display="none";
  greeting.style.display="block";
  greeting.textContent=`ğŸ‘‹ ${player}ë‹˜, í•˜ë…¸ì´íƒ‘ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!`;
  document.getElementById('levelButtons').style.display="block";
  canvas.style.display="block"; info.style.display="block";
  document.getElementById('modebar').style.display="block";
  document.getElementById('restartBtn').style.display="inline-block";
  document.getElementById('undoBtn').style.display="inline-block";
  document.getElementById('helpBtn').style.display="inline-block";
  document.getElementById('showRecords').style.display="inline-block";
  document.getElementById('showSummary').style.display="inline-block";
  initGame(n);
}
function initGame(numDisks){
  pegs=[[],[],[]]; moveHistory=[];
  for(let i=numDisks;i>=1;i--) pegs[0].push(i);
  selectedPeg=null; moveCount=0; elapsed=0; attackTimeOver=false;
  clearInterval(timerInterval); startTime=Date.now();

  if(mode==='attack'){
    const perfectSec=minMovesOf(n)*OPT_TIME_PER_MOVE;
    attackTimeLimitMs=Math.round(perfectSec*ATTACK_TIME_FACTOR*1000);
  } else attackTimeLimitMs=0;

  timerInterval=setInterval(updateTime,100);
  document.getElementById('perfect').textContent="";
  draw(); updateInfo();
}

/* ===== ì‹œê°„/ì •ë³´ ===== */
function updateTime(){
  elapsed=Date.now()-startTime;
  if(mode==='attack' && elapsed>=attackTimeLimitMs && !attackTimeOver){
    attackTimeOver=true; clearInterval(timerInterval); updateInfo();
    afterPaint(()=>alert("â° ì‹œê°„ ì´ˆê³¼! ë‹¤ì‹œí•˜ê¸°(ğŸ”„) ë²„íŠ¼ìœ¼ë¡œ ì¬ë„ì „í•˜ì„¸ìš”."));
  }
  updateInfo();
}
function updateInfo(){
  if(mode==='attack'){
    const remain=Math.max(0,attackTimeLimitMs-elapsed);
    info.textContent=`ëª¨ë“œ: íƒ€ì„ì–´íƒ | ë ˆë²¨ ${n-4} | ì´ë™ íšŸìˆ˜: ${moveCount} | ë‚¨ì€: ${formatTime(remain)} / ì œí•œ: ${formatTime(attackTimeLimitMs)}`;
  } else if (mode==='normal'){
    info.textContent=`ëª¨ë“œ: ì¼ë°˜ | ë ˆë²¨ ${n-4} | ì´ë™ íšŸìˆ˜: ${moveCount} | ì‹œê°„: ${formatTime(elapsed)} (ê¸°ë¡ ì €ì¥)`;
  } else {
    info.textContent=`ëª¨ë“œ: ì—°ìŠµ | ë ˆë²¨ ${n-4} | ì´ë™ íšŸìˆ˜: ${moveCount} | ì‹œê°„: ${formatTime(elapsed)} (ì €ì¥ ì•ˆ í•¨)`;
  }
}

/* ===== ê·¸ë¦¬ê¸° ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const center=canvas.width/2;
  const pegX=[center-PEG_SPACING, center, center+PEG_SPACING];

  // ê¸°ë‘¥ + ë¼ë²¨
  pegX.forEach((x,i)=>{
    ctx.fillStyle=(selectedPeg===i)?"#ff7070":"#888";
    ctx.fillRect(x-5,150,10,200);
    ctx.fillStyle="#333"; ctx.font="18px ë§‘ì€ ê³ ë”•"; ctx.textAlign="center";
    ctx.fillText(String.fromCharCode(65+i), x, 390);
  });

  // ì›íŒ + ë²ˆí˜¸
  for(let i=0;i<3;i++){
    const peg=pegs[i];
    for(let j=0;j<peg.length;j++){
      const disk=peg[j];
      const width=disk*DISK_SCALE;
      const x=pegX[i]-width/2;
      const y=330-j*20;
      ctx.fillStyle=`hsl(${disk*35},70%,55%)`;
      ctx.fillRect(x,y,width,18);
      ctx.fillStyle="white"; ctx.font="bold 14px ë§‘ì€ ê³ ë”•"; ctx.textAlign="center";
      ctx.fillText(String(disk), pegX[i], y+14);
    }
  }
}

/* ===== ì…ë ¥ ì²˜ë¦¬ (í´ë¦­+í„°ì¹˜) ===== */
function actOnPeg(pegIndex){
  if(mode==='attack' && attackTimeOver){ afterPaint(()=>alert("â° ì‹œê°„ ì´ˆê³¼! ë‹¤ì‹œí•˜ê¸°(ğŸ”„) ë²„íŠ¼ìœ¼ë¡œ ì¬ë„ì „í•˜ì„¸ìš”.")); return; }
  if(selectedPeg===null){
    if(pegs[pegIndex].length>0){ selectedPeg=pegIndex; draw(); }
  }else{
    if(selectedPeg!==pegIndex){
      const fromPeg=pegs[selectedPeg], toPeg=pegs[pegIndex];
      const moving=fromPeg[fromPeg.length-1], topTo=toPeg[toPeg.length-1];
      if(!topTo || moving<topTo){
        toPeg.push(fromPeg.pop()); moveHistory.push([selectedPeg,pegIndex]); moveCount++;
      }else afterPaint(()=>alert("âŒ í° ì›íŒ ìœ„ì— ì‘ì€ ì›íŒë§Œ ë†“ì„ ìˆ˜ ìˆì–´ìš”!"));
    }
    selectedPeg=null; draw(); updateInfo(); checkWin();
  }
}
function handlePoint(clientX){
  const rect=canvas.getBoundingClientRect();
  const x=clientX-rect.left;
  const pegIndex = x < rect.width/3 ? 0 : (x < rect.width*2/3 ? 1 : 2);
  actOnPeg(pegIndex);
}
canvas.addEventListener('click',e=>handlePoint(e.clientX));
canvas.addEventListener('pointerdown',e=>{ if(e.pointerType!=='mouse'){ e.preventDefault(); handlePoint(e.clientX); } });

/* ===== ë²„íŠ¼ ===== */
function restartLevel(){ setLevel(n); }
function undoMove(){
  if(moveHistory.length===0) return afterPaint(()=>alert("ë˜ëŒë¦´ ì´ë™ì´ ì—†ìŠµë‹ˆë‹¤."));
  const [from,to]=moveHistory.pop(); const disk=pegs[to].pop(); pegs[from].push(disk);
  moveCount=Math.max(0,moveCount-1); selectedPeg=null; draw(); updateInfo();
}
function showBestRecords(){
  // ì¼ë°˜/íƒ€ì„ì–´íƒ ê°ê° ë ˆë²¨ë³„ ìµœê³  ê¸°ë¡ í‘œì‹œ
  let result=`ğŸ† ${player}ë‹˜ì˜ ìµœê³ ê¸°ë¡\n`;
  const modesToShow=['normal','attack'];
  for(const m of modesToShow){
    result += `\n[${modeLabel(m)}]\n`;
    let any=false;
    for(let i=5;i<=10;i++){
      const key=bestKey(player,i,m);
      const rec=localStorage.getItem(key);
      if(rec){ result += `ë ˆë²¨ ${i-4}: ${rec}ì´ˆ\n`; any=true; }
    }
    if(!any) result += "(ê¸°ë¡ ì—†ìŒ)\n";
  }
  alert(result.trim());
}
function showSummaryRecords(){
  // ëª¨ë“  ë ˆë²¨ì˜ í‰ê· /ì´í•© (ì¼ë°˜/íƒ€ì„ì–´íƒ ê°ê°)
  let msg = `ğŸ“Š ì „ì²´ ê¸°ë¡ ìš”ì•½ (${player})\n`;
  for(const m of ['normal','attack']){
    let times=[];
    for(let i=5;i<=10;i++){
      const rec=localStorage.getItem(bestKey(player,i,m));
      if(rec){ const s=parseFloat(rec); if(!isNaN(s)) times.push(s); }
    }
    msg += `\n[${modeLabel(m)}]\n`;
    if(times.length){
      const total = times.reduce((a,b)=>a+b,0);
      const avg = total / times.length;
      msg += `- ê¸°ë¡ ìˆ˜: ${times.length}ê°œ\n`;
      msg += `- í‰ê· : ${formatTime(Math.round(avg*1000))}\n`;
      msg += `- ì´í•©: ${formatTime(Math.round(total*1000))}\n`;
    } else {
      msg += "(ê¸°ë¡ ì—†ìŒ)\n";
    }
  }
  alert(msg.trim());
}
function showRules(){ alert(RULES_TEXT); }
function setGameMode(m){ if(!['practice','normal','attack'].includes(m)) return; mode=m; initGame(n); }

/* ===== í´ë¦¬ì–´ íŒì • (afterPaintë¡œ ì™„ì„± ê·¸ë¦¼ ë¨¼ì € í‘œì‹œ) ===== */
function checkWin(){
  if(pegs[2].length!==n) return;
  clearInterval(timerInterval);
  selectedPeg=null; draw(); updateInfo();

  const minMoves=minMovesOf(n), timeSec=elapsed/1000;
  const perfectLimit=minMoves*OPT_TIME_PER_MOVE;
  const isPerfect=(moveCount===minMoves) && (timeSec<=perfectLimit);

  if(mode==='attack' && attackTimeOver) return afterPaint(()=>alert("â° ì‹œê°„ ì´ˆê³¼ë¡œ ì‹¤íŒ¨! ë‹¤ì‹œ ë„ì „í•´ ë³´ì„¸ìš”."));

  let msg=`ğŸ‰ ${player}ë‹˜, ë ˆë²¨ ${n-4} í´ë¦¬ì–´!\n`;

  if(mode==='practice'){
    msg+=`ê²½ê³¼ ì‹œê°„: ${formatTime(elapsed)}\nì´ë™ íšŸìˆ˜: ${moveCount}íšŒ\n(ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” ê¸°ë¡ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`;
    if(isPerfect) msg+=`\nğŸ¯ Perfect!! (ìµœì†Œ ${minMoves}íšŒ, ${perfectLimit.toFixed(1)}ì´ˆ ì´ë‚´)`;
    return afterPaint(()=>{ if(isPerfect){ const el=document.getElementById('perfect'); el.textContent="ğŸ¯ Perfect!!"; setTimeout(()=>{el.textContent="";},3000);} alert(msg.trim()); if(n<10) setTimeout(()=>setLevel(n+1),1000); });
  }

  // ê¸°ë¡ ì €ì¥ ëª¨ë“œ(ì¼ë°˜/íƒ€ì„ì–´íƒ)
  const key=bestKey(player,n,mode);
  const prev=localStorage.getItem(key);
  const cur=timeSec.toFixed(1);
  msg+=`ê²½ê³¼ ì‹œê°„: ${formatTime(elapsed)}\nì´ë™ íšŸìˆ˜: ${moveCount}íšŒ\n`;
  let isNew=false;
  if(!prev || parseFloat(cur)<parseFloat(prev)){ localStorage.setItem(key,cur); msg+="ğŸ† (ì‹ ê¸°ë¡!)\n"; isNew=true; }
  else msg+=`ìµœê³ ê¸°ë¡: ${prev}ì´ˆ\n`;
  if(isPerfect) msg+=`ğŸ¯ Perfect!! (ìµœì†Œ ${minMoves}íšŒ, ${perfectLimit.toFixed(1)}ì´ˆ ì´ë‚´)\n`;

  afterPaint(()=>{
    if(isPerfect){ const el=document.getElementById('perfect'); el.textContent="ğŸ¯ Perfect!!"; setTimeout(()=>{el.textContent="";},3000); }
    if(isNew) highlightNewRecord(mode);
    alert(msg.trim());
    if(n<10) setTimeout(()=>setLevel(n+1),1000);
  });
}

function setLevel(level){ n=level; initGame(level); }
</script>
</body>
</html>
